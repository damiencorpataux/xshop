<?xml version="1.0" encoding="UTF-8"?>
<html>
  <head>
    <title>Development</title>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="http://extjs-public.googlecode.com/svn/tags/ext-2.2/release/resources/css/ext-all.css" />
    <link rel="stylesheet" href="css/main.css" type="text/css" />
    <style>
      body {
        font-family: 'Trebuchet MS',Tahoma,sans-serif,
        font-size: 9px;
        color: #00802B;
      }
      .product {
        background: white;
        /*border: 1px solid gray;*/
        margin: 10px;
        padding: 10px;
        text-align: center;
        float: left;
      }
      .product img {
        opacity: 0.66;
        filter: alpha(opacity=66); 
      }
      .product img:hover {
        opacity: 1.00;
        filter: alpha(opacity=100);

      }
    </style>
  </head>
  <body>
    <div id="panel">
    </div>

    <script type="text/javascript" src="http://extjs-public.googlecode.com/svn/tags/ext-2.2/release/adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="http://extjs-public.googlecode.com/svn/tags/ext-2.2/release/ext-all.js"></script>
    <script>
      function init() {
          Ext.namespace("xshop");
          Ext.namespace("xshop.dd");

          xshop.dd.ProductProxy = Ext.extend(Ext.dd.DDProxy, {
              constructor: function(config) {
                  xshop.dd.ProductProxy.superclass.constructor.apply(this, arguments);
              },
              onDragOver: function(e, targetId) {
                  //console.log(targetId);//, Ext.get(targetId));
              },
              endDrag: function() {
                  //console.log(this);
              }
          });

          xshop.Product = Ext.extend(Ext.Panel, {
              constructor: function(config) {
                  Ext.apply(this, {
                      width: 200,
                      border: false,
                      cls: 'product'
                  });
                  xshop.Product.superclass.constructor.apply(this, arguments);
                  Ext.apply(this, config);
                  this.html = this.template.apply(config.data);
                  this.add(new Ext.Button({
                      text: 'Ajouter au panier',
                      listeners: {
                          click: function(button, e) {
                              e.stopEvent();
                              this.cart.addProduct(this.data);
                          },
                          scope: this
                      }
                  }));
                  ww=this;
                  this.on({
                      render: function() {
                          Ext.EventManager.addListener(this.el.dom, 'click', function() {
                              var w = new Ext.Window({
                                  html: '<h1>Product description</h1><img src="'+this.data.imgurl+'"/>',
                                  modal: true,
                                  width: '80%',
                                  height: '80%'
                              });
                              w.show();
                          }, this);
                      }
                  });
              },
              data: null,
              cart: null,
              template: new Ext.Template(
                  '<div id="product_{id}">',
                      '<strong>{name}</strong><br/>',
                      '<img src="{imgurl}"/>',
                      '<div>{price} CHF</div>',
                  '</div>'
              )
          });
          Ext.reg('xs.product', xshop.Product);

          xshop.Products = Ext.extend(Ext.Panel, {
              constructor: function(config) {
                  Ext.apply(this, {
                      autoScroll: true
                  });
                  xshop.Products.superclass.constructor.apply(this, arguments);
                  Ext.apply(this, config);
                  this.store = new Ext.data.JsonStore({
                      url: 'products.json',
                      root: 'products', // Can we have no root (a json with a root array)?
                      idProperty: 'id',
                      fields: ['id', 'name', 'imgurl', 'price']
                  });
                  this.store.on('datachanged', function() {
                      this.clearProducts();
                      this.addProducts();
                  }, this);
                  this.store.load();
              },
              cart: null,
              store: null,
              clearProducts: function() {
                  if (!this.items) return;
                  while (this.items.items.length) {
                      this.remove(this.items.items[0]);
                  }
                  //this.removeAll(true);
              },
              addProducts: function() {
                  this.store.each(function(record) {
                      var product = new xshop.Product({
                          data: record.data,
                          cart: this.cart,
                          listeners: {
                              render: function() {new xshop.dd.ProductProxy(this.id, 'group')}
                          }
                      });
                      this.add(product);
                      this.doLayout();
                  }, this);
              }
          });
          Ext.reg('xs.products', xshop.Products);

          xshop.Cart = Ext.extend(Ext.Panel, {
              constructor: function(config) {
                  Ext.apply(this, {
                      html: '<img id="xscart" src="img/cart.jpg"/><div id="cartdetails"></div>'
                  });
                  xshop.Cart.superclass.constructor.apply(this, arguments);
                  this.on({afterrender: this.refreshDetails});
              },
              data: {
                  products: [],
                  price: 0
              },
              template: new Ext.Template(
                  '<strong>{nitems} produit</strong> pour <strong>{totalprice} CHF</strong><br/>'
              ),
              addProduct: function(product) {
                  this.data.products.push(product);
                  this.data.price += parseFloat(product.price);
                  this.refreshDetails();
              },
              removeProduct: function(mixed) {
                  // TODO: remove products by id, product object or index
              },
              refreshDetails: function() {
                  Ext.get('cartdetails').dom.innerHTML = this.template.apply({
                      nitems: this.data.products.length,
                      totalprice: this.data.price
                  });
              }
          });
          Ext.reg('xs.cart', xshop.Cart);

          var cart = new xshop.Cart();
          var products = new xshop.Products({ cart: cart });
          var searchField = new Ext.form.TextField({
              enableKeyEvents: true,
              listeners: {
                  keyup: function() {
                      products.store.clearFilter();
                      products.store.filter('name', this.getValue(), true, false);
                  }
              }
          });

          new Ext.Viewport({
              layout: 'border',
              items: [Ext.apply(searchField, {
                  region: 'north',
                  autoHeight: true,
                  border: false,
                  margins: '0 0 5 0'
              }), Ext.apply(products, {
                  region: 'center'
              }), Ext.apply(cart, {
                  region: 'east',
                  collapsible: true,
                  collapseMode: 'mini',
                  split: true,
                  width: 200
              })]
          });
      }
      Ext.onReady(init);
    </script>
  </body>
</html>

